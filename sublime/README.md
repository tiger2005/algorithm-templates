### `sublime/` - 插件

这个文档会对插件的工作原理进行介绍，方便开发人员或者使用者进行分析。

#### 展开操作

展开操作将会在 Sublime Text 的 `TextCommand` 中以 `action=expand` 作为参数调用 `run()`，可以查看键位绑定文件（`xxx.sublime-keymap`）确定行为。

此时插件得到当前的 `Sublime.View`，并尝试读取设置文件中的 `file-prefix`，读取成功后进入分支。

在分支中，我们的目的是确定源代码的插入列表，其中包含每一段代码需要插入的位置和内容。另外，为了保证同样的代码（依赖）不添加两次，我们通过 `list` 进行去重。

对模板库的文件是借助深度优先搜索进行的，对于一个文件，会进行如下操作：

1. 尝试从 `list` 中查找这个文件，如果存在就退出。
2. 将这个文件加入到 `list`。
3. 尝试读取这个文件，失败则退出，否则得到代码行列表。
4. 将 line 设定为代码的第一行。
5. 如果 line 是一个引用 `#include "lib/xxx"`，则获取引用的文件位置，并以依赖项的身份进行深度优先搜索，将植入位置定为当前文件内容的前面。
6. 否则，如果 line 恰好是 `// impl`，则标志植入的开始。
7. 否则，如果当前标注了植入的开始，而且 line 不为空，则将待加入的文件内容中加入这一行。
8. 如果还有下一行，将 line 设置为下一行，并返回 5.。
9. 向插入列表中加入这部分的信息。

最后，我们考虑倒序插入代码，以保证后面代码的插入不会影响前面代码的 `Sublime.Region`。插入完毕后，居中视角即可。

#### 折叠操作

折叠操作类似，传入的参数为 `action=collapse`。值得注意的是，我们在插入代码的同时，在前后添加了特殊标记（直接引用和依赖项引用不一样），所以只需要通过类似于括号匹配的形式，就可以进行折叠。此处不再赘述。